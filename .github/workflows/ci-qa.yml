name: Docker Build + QA (Panther)

on:
  pull_request:
  push:

jobs:
  qa:
    runs-on: ubuntu-latest
    env:
      TSUGI_BASE_URL: http://localhost:8888/tsugi
      TSUGI_ADMIN_PW: tsugi-admin
      TSUGI_DOCKER_FORCE_CONFIG: "1"
      PANTHER_NO_SANDBOX: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer
          extensions: dom, xml, xmlwriter, mbstring

      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Install Chromium
        run: |
          sudo apt-get -qq update
          if ! sudo apt-get -qq install -y chromium-browser; then
            sudo apt-get -qq install -y chromium
          fi
          if command -v chromium-browser >/dev/null; then
            echo "CHROME_BIN=$(command -v chromium-browser)" >> $GITHUB_ENV
          elif command -v chromium >/dev/null; then
            echo "CHROME_BIN=$(command -v chromium)" >> $GITHUB_ENV
          fi

      - name: Install browser drivers
        run: vendor/bin/bdi detect drivers

      - name: Bootstrap sample tools
        run: ./qa/scripts/qa-bootstrap-tools.sh

      - name: Start Tsugi (Docker)
        run: docker compose up -d

      - name: Wait for Tsugi
        run: |
          for i in {1..30}; do
            if curl -fsS "${TSUGI_BASE_URL}" >/dev/null; then
              exit 0
            fi
            sleep 3
          done
          echo "Timed out waiting for ${TSUGI_BASE_URL}"
          exit 1

      - name: Run Panther QA
        env:
          PANTHER_CHROME_ARGUMENTS: "--headless=new --no-sandbox --disable-dev-shm-usage"
        run: vendor/bin/phpunit -c qa/phpunit.xml

      - name: Add screenshot to summary
        if: always()
        run: |
          if [ -f qa/screenshots/homepage.png ]; then
            echo "## Homepage screenshot" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "![](data:image/png;base64,$(base64 -w 0 qa/screenshots/homepage.png))" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Homepage screenshot" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "_Screenshot not found: qa/screenshots/homepage.png_" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload homepage screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-homepage-screenshot
          path: qa/screenshots/homepage.png
          if-no-files-found: warn

      - name: Docker logs (on failure)
        if: failure()
        run: docker compose logs --no-color
